#!/bin/bash

source=/mnt/datasets/Tracking/Telonics/Output
base="https://api.npolar.no/tracking/polar-bear"
dir=`dirname $0`
i=0

for f in $source/*Condensed.csv
do
  
  platform=`basename "$f" ".csv" | grep -oE "^\w*\b"`
	
  # Get latest timestamp in API    
  api="$base?q=&limit=1&format=csv&sort=-properties.time&fields=properties.time&filter-properties.platform=$platform"
  for row in `curl -n -XGET --silent "$api"`
  do
    t=`echo $row | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9:\.Z\+\-\s]+'`
    if [ -z "$t" -a "$t" == " " ]; then
      t="-1"  
    fi  
  done
  
  json=`$dir/telonics-csv-to-json "$f" $t features`
  if [ ${#json} -gt 4 ];
  then
    echo $json | curl -H "Content-Type: application/json" -vn -XPOST "$base" -d@-
  fi
  
done